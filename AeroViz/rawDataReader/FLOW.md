# RawDataReader 處理流程

## 流程圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            RawDataReader(inst, path, start, end, qc=True)   │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  1. _raw_reader()                                                           │
│     ├─ 讀取原始檔案 (*.dat, *.txt, *.csv)                                    │
│     ├─ 時間解析度: 儀器原生 (1min/5min/6min/1h)                              │
│     └─ 欄位: 原始量測值                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  2. _timeIndex_process()                                                    │
│     └─ 對齊標準時間索引                                                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  3. _QC()                                                                   │
│     ├─ QCFlagBuilder 根據規則標記資料                                        │
│     ├─ 新增 QC_Flag 欄位 ("Valid" / "Status Error" / "Insufficient" / ...)  │
│     └─ 暫存 QC Summary (待 _process 輸出)                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  4. _process()                                                              │
│     ├─ 計算衍生參數 (BC, Abs, AAE, GMD, GSD, etc.)                          │
│     ├─ 額外 QC 驗證 (如 Invalid AAE) 並更新 QC_Flag                          │
│     └─ 輸出完整 QC Summary (含 _QC 規則 + _process 驗證結果)                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  5. _save_data()                                                            │
│     ├─ 儲存 raw_data.pkl / raw_data.csv                                     │
│     └─ 儲存 qc_data.pkl / qc_data.csv                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  6. __call__() - QC 處理                                                    │
│     ├─ 根據 QC_Flag 將無效資料設為 NaN                                       │
│     └─ 移除 QC_Flag 欄位                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  7. _generate_report()                                                      │
│     ├─ calculate_rates(raw_data, qc_flag)                                   │
│     │   ├─ Acquisition Rate: 有資料的時段 / 期望時段                         │
│     │   ├─ Yield Rate: 通過 QC 的時段 / 有資料的時段                         │
│     │   └─ Total Rate: 通過 QC 的時段 / 期望時段                             │
│     └─ process_rates_report() - 生成週/月報告                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  8. 最終輸出                                                                 │
│     ├─ resample(mean_freq) - 重採樣至使用者指定頻率 (預設 1h)                 │
│     ├─ 儲存 output_{inst}.csv                                               │
│     ├─ 儲存 output_{inst}_dN/dS/dVdlogDp.csv (SMPS/APS)                     │
│     ├─ 儲存 report.json                                                     │
│     └─ 返回 DataFrame                                                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 資料欄位變化

| 階段 | 欄位範例 (AE33) | 欄位範例 (APS) |
|-----|----------------|---------------|
| `_raw_reader` | BC1-7, ATN, Flow, Status... | 粒徑 bins (0.5-20 μm) |
| `_QC` | + `QC_Flag` | + `QC_Flag` |
| `_process` | + Abs_370-950, AAE | + total, GMD, GSD, mode (num/surf/vol) |
| `__call__` | 無效資料 → NaN，移除 QC_Flag | 無效資料 → NaN，移除 QC_Flag |
| 最終輸出 | BC, Abs, AAE | 統計參數 (無 bins) |

## QC_Flag 的角色

```
QC_Flag 貫穿整個流程：
  _QC()              → 建立 QC_Flag，暫存 Summary
  _process()         → 更新 QC_Flag (如 Invalid AAE)，輸出完整 QC Summary
  _generate_report() → 使用 QC_Flag 計算 rates
  __call__()         → 使用 QC_Flag 標記無效資料為 NaN，然後移除
```

## QC Summary 輸出格式

```
AE33 QC Summary:
  Status Error: 24312 (4.9%)
  Invalid BC: 29265 (5.9%)
  Insufficient: 105481 (21.1%)
  Invalid AAE: 25948 (5.2%)
  Valid: 356025 (71.2%)
```

## 各儀器原生時間解析度

| 儀器 | 原生頻率 | 主要輸出參數 |
|-----|---------|-------------|
| **NEPH** | 5 min | 散射係數 (G), sca_550, SAE |
| **Aurora** | 1 min | 散射係數 (G), sca_550, SAE |
| **SMPS** | 6 min | total, GMD, GSD, mode (num/surf/vol) |
| **APS** | 6 min | total (1μm/2.5μm/all), GMD, GSD, mode |
| **GRIMM** | 6 min | 粒徑分佈統計 |
| **AE33** | 1 min | BC, Abs coef, AAE |
| **AE43** | 1 min | BC, Abs coef, AAE |
| **BC1054** | 1 min | BC, Abs coef, AAE |
| **MA350** | 1 min | BC, Abs coef, AAE |
| **BAM1020** | 1 h | PM 質量濃度 |
| **TEOM** | 6 min | PM_Total, PM_NV |
| **OCEC** | 1 h | Thermal/Optical OC & EC |
| **IGAC** | 1 h | 離子濃度 (9種) |
| **XRF** | 1 h | 元素濃度 |
| **VOC** | 1 h | VOC 濃度 |
| **EPA** | 1 h | 環保署監測數據 |

## Rate 計算說明

- **Acquisition Rate**: `有資料的時段數 / 期望的時段數 × 100%`
  - 反映儀器的資料取得率

- **Yield Rate**: `通過 QC 的時段數 / 有資料的時段數 × 100%`
  - 反映資料的品質良率

- **Total Rate**: `通過 QC 的時段數 / 期望的時段數 × 100%`
  - 反映整體有效資料比例

計算時使用 QC_Flag，每個時段內若超過 50% 的資料點為 "Valid"，則該時段視為有效。
